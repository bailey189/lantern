{% extends 'base.html' %}

{% block title %}Lantern - Network{% endblock %}

{% block header_subtitle %}
Network Topology
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">Network Topology (3D)</h2>
    <div id="network3d" style="width: 100%; height: 600px; border: 1px solid #ddd; background: #05070c; position: relative;"></div>
    <div id="asset-info-panel" class="mt-4" style="display:none; max-width:600px;">
        <h4>Asset Information</h4>
        <form id="asset-info-form" autocomplete="off">
            <table class="table table-bordered align-middle">
                <tbody id="asset-info-table">
                    <!-- Populated by JS -->
                </tbody>
            </table>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">Save</button>
                <button type="button" class="btn btn-secondary" onclick="hideAssetInfo()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
body { margin: 0; overflow: hidden; background: #05070c; }
#network3d canvas { display: block; }
.label {
  color: #00f6ff;
  font-family: monospace;
  font-size: 14px;
  text-shadow: 0 0 4px #00f6ff, 0 0 8px #00f6ff;
  white-space: nowrap;
}
.link-label {
  color: #fffc7a;
  font-family: monospace;
  font-size: 12px;
  text-shadow: 0 0 4px #fffc7a, 0 0 6px #fffc7a;
  white-space: nowrap;
}
</style>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.161/examples/jsm/controls/OrbitControls.js";
import { CSS2DRenderer, CSS2DObject } from "https://cdn.jsdelivr.net/npm/three@0.161/examples/jsm/renderers/CSS2DRenderer.js";

// Scene setup
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x05070c);

const container = document.getElementById('network3d');
const width = container.clientWidth;
const height = container.clientHeight;

const camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
camera.position.set(8, 10, 18);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(width, height);
container.appendChild(renderer.domElement);

const labelRenderer = new CSS2DRenderer();
labelRenderer.setSize(width, height);
labelRenderer.domElement.style.position = "absolute";
labelRenderer.domElement.style.top = "0";
labelRenderer.domElement.style.pointerEvents = "none";
container.appendChild(labelRenderer.domElement);

// Controls
const controls = new OrbitControls(camera, labelRenderer.domElement);
controls.enableDamping = true;

// Lights
scene.add(new THREE.AmbientLight(0x555555));
const pointLight = new THREE.PointLight(0x00ffff, 1.2, 100);
pointLight.position.set(10, 15, 10);
scene.add(pointLight);

// Node factory
function makeNode(name, color, position) {
  const geometry = new THREE.SphereGeometry(0.6, 32, 32);
  const material = new THREE.MeshStandardMaterial({
    color,
    emissive: color,
    emissiveIntensity: 0.6,
    metalness: 0.3,
    roughness: 0.2
  });
  const node = new THREE.Mesh(geometry, material);
  node.position.copy(position);

  const div = document.createElement("div");
  div.className = "label";
  div.textContent = name;
  const label = new CSS2DObject(div);
  label.position.set(0, 1, 0);
  node.add(label);

  scene.add(node);
  return node;
}

// Store animated pulses
const pulses = [];

// Link factory with label and pulse animation
function makeLink(start, end, color, labelText) {
  // Base line
  const points = [start.clone(), end.clone()];
  const geometry = new THREE.BufferGeometry().setFromPoints(points);
  const material = new THREE.LineBasicMaterial({ color, linewidth: 2 });
  const line = new THREE.Line(geometry, material);
  scene.add(line);

  // Floating label
  if (labelText) {
    const div = document.createElement("div");
    div.className = "link-label";
    div.textContent = labelText;
    const label = new CSS2DObject(div);
    const midpoint = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
    label.position.copy(midpoint);
    scene.add(label);
  }

  // Pulse sphere (animated)
  const pulseGeom = new THREE.SphereGeometry(0.15, 16, 16);
  const pulseMat = new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.9 });
  const pulse = new THREE.Mesh(pulseGeom, pulseMat);
  scene.add(pulse);

  pulses.push({
    mesh: pulse,
    start,
    end,
    progress: 0,
    speed: 0.005 + Math.random() * 0.005 // slightly varied speeds
  });
}

// Layout positions
const internet = makeNode("INTERNET", 0x24d1ff, new THREE.Vector3(0, 6, 0));
const firewall = makeNode("FIREWALL", 0xff3300, new THREE.Vector3(0, 3.5, 0));
const webserver = makeNode("Webserver01", 0x2ea3ff, new THREE.Vector3(-4, 1.5, 0));
const mail = makeNode("Mail01", 0x2ea3ff, new THREE.Vector3(4, 1.5, 0));
const db = makeNode("Database02", 0x9b6cff, new THREE.Vector3(-4, -1, 0));
const router = makeNode("Router01", 0x39d353, new THREE.Vector3(4, -1, -2));
const file = makeNode("Fileserver1", 0x39d353, new THREE.Vector3(4, -1, 2));

// Connections with labels and pulses
makeLink(internet.position, firewall.position, 0xff5555, "TCP 443 HTTPS");
makeLink(firewall.position, webserver.position, 0xff5555, "TCP 80/443");
makeLink(firewall.position, mail.position, 0xff5555, "SMTP 25 / IMAP 143");
makeLink(webserver.position, db.position, 0x5fb0ff, "SQL 3306");

// Animate loop
function animate() {
  requestAnimationFrame(animate);

  // Update pulse positions
  pulses.forEach(p => {
    p.progress += p.speed;
    if (p.progress > 1) p.progress = 0;
    const pos = new THREE.Vector3().lerpVectors(p.start, p.end, p.progress);
    p.mesh.position.copy(pos);
    // Fade in/out effect
    p.mesh.material.opacity = Math.sin(p.progress * Math.PI) * 0.9;
  });

  controls.update();
  renderer.render(scene, camera);
  labelRenderer.render(scene, camera);
}
animate();

// Resize handling
addEventListener("resize", () => {
  const width = container.clientWidth;
  const height = container.clientHeight;
  camera.aspect = width / height;
  camera.updateProjectionMatrix();
  renderer.setSize(width, height);
  labelRenderer.setSize(width, height);
});
</script>
{% endblock %}

{% block footer %}{% endblock %}